name: Docs

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-quality:
    name: Markdown lint and link checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          config: .markdownlint.json
          globs: |
            README.md
            USAGE.md
            SECURITY.md
            docs/**/*.md

      - name: Check internal markdown links
        run: ./scripts/check-doc-links.sh

      - name: Check external links
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >-
            --config .lychee.toml
            README.md
            USAGE.md
            SECURITY.md
            docs/**/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Build and deploy unified docs to GitHub Pages
    needs: docs-quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install honkit
        run: npm install -g honkit@6

      - name: Build markdown docs with honkit
        run: honkit build

      - name: Create unified documentation structure
        run: |
          mkdir -p docs-build/unified

          # Copy honkit markdown docs to guides/
          cp -r _book docs-build/unified/guides

          # Create landing page
          cat > docs-build/unified/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Proton Git LFS Documentation</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 900px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
                color: #333;
              }
              h1 {
                border-bottom: 3px solid #6d4aff;
                padding-bottom: 10px;
                color: #1a1a1a;
              }
              .intro {
                margin: 20px 0;
                padding: 20px;
                background: #e8f4fd;
                border-radius: 8px;
                border-left: 4px solid #0066cc;
              }
              .section {
                margin: 30px 0;
                padding: 25px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #6d4aff;
              }
              .section h2 {
                margin-top: 0;
                color: #6d4aff;
              }
              a {
                color: #6d4aff;
                text-decoration: none;
                font-weight: 500;
              }
              a:hover {
                text-decoration: underline;
              }
              .badge {
                display: inline-block;
                padding: 4px 10px;
                background: #6d4aff;
                color: white;
                border-radius: 4px;
                font-size: 0.85em;
                margin-left: 10px;
                font-weight: 600;
              }
              .external-badge {
                background: #28a745;
              }
              ul {
                margin: 15px 0;
                padding-left: 20px;
              }
              li {
                margin: 8px 0;
              }
              footer {
                margin-top: 60px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
                text-align: center;
                color: #666;
                font-size: 0.9em;
              }
              code {
                background: #f4f4f4;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ“¦ Proton Git LFS Documentation</h1>

            <div class="intro">
              <p><strong>Proton Git LFS</strong> is a Git LFS custom transfer adapter that provides encrypted storage for Git LFS objects via Proton Drive.</p>
              <p>This documentation covers the Go adapter, system tray app, and integration with the TypeScript bridge.</p>
            </div>

            <div class="section">
              <h2>ðŸ“— Architecture & Guides <span class="badge">Markdown</span></h2>
              <p>High-level architecture, setup guides, testing, security, and operational documentation.</p>
              <ul>
                <li><a href="guides/index.html">Documentation Home</a></li>
                <li><a href="guides/docs/architecture/overview.html">Architecture Overview</a></li>
                <li><a href="guides/docs/project/project-plan.html">Project Plan</a></li>
                <li><a href="guides/docs/security/threat-model.html">Security & Threat Model</a></li>
                <li><a href="guides/docs/testing/integration-testing.html">Integration Testing</a></li>
                <li><a href="guides/docs/operations/adapter-configuration.html">Adapter Configuration</a></li>
              </ul>
            </div>

            <div class="section">
              <h2>ðŸ“˜ Go API Reference <span class="badge external-badge">pkg.go.dev</span></h2>
              <p>Complete Go API documentation automatically generated from Go doc comments.</p>
              <ul>
                <li><a href="https://pkg.go.dev/github.com/SevenOfNine-ai/proton-git-lfs">Go Package Documentation</a></li>
                <li><a href="https://pkg.go.dev/github.com/SevenOfNine-ai/proton-git-lfs/cmd/adapter">Adapter Package</a></li>
                <li><a href="https://pkg.go.dev/github.com/SevenOfNine-ai/proton-git-lfs/cmd/tray">Tray App Package</a></li>
                <li><a href="https://pkg.go.dev/github.com/SevenOfNine-ai/proton-git-lfs/internal/config">Config Package</a></li>
                <li>Coverage: Git LFS Adapter, System Tray, Configuration, Status Reporting</li>
              </ul>
            </div>

            <div class="section">
              <h2>ðŸ“™ TypeScript Bridge API <span class="badge external-badge">Submodule</span></h2>
              <p>TypeScript CLI and bridge protocol documentation for the proton-drive-cli submodule.</p>
              <ul>
                <li><a href="https://sevenofnine-ai.github.io/proton-drive-cli/">TypeScript API Documentation</a></li>
                <li>Coverage: CLI Commands, Authentication, Drive Operations, Bridge Protocol, Utilities</li>
              </ul>
            </div>

            <div class="section">
              <h2>ðŸ”— Quick Links</h2>
              <ul>
                <li><a href="https://github.com/SevenOfNine-ai/proton-git-lfs">GitHub Repository</a></li>
                <li><a href="https://github.com/SevenOfNine-ai/proton-git-lfs/blob/main/README.md">README</a></li>
                <li><a href="https://github.com/SevenOfNine-ai/proton-git-lfs/blob/main/USAGE.md">Usage Guide</a></li>
                <li><a href="https://github.com/SevenOfNine-ai/proton-git-lfs/blob/main/docs/DOCUMENTATION_GUIDE.md">Go Documentation Guide</a></li>
                <li><a href="https://github.com/SevenOfNine-ai/proton-drive-cli">Submodule: proton-drive-cli</a></li>
              </ul>
            </div>

            <div class="section">
              <h2>ðŸš€ Getting Started</h2>
              <ul>
                <li><a href="guides/index.html">Read the Documentation</a></li>
                <li><a href="https://github.com/SevenOfNine-ai/proton-git-lfs#installation">Installation Instructions</a></li>
                <li><a href="guides/docs/operations/adapter-configuration.html">Configure the Adapter</a></li>
                <li><a href="guides/docs/testing/integration-testing.html">Run Tests</a></li>
              </ul>
            </div>

            <footer>
              <p>Generated with Honkit | Go docs via <a href="https://pkg.go.dev">pkg.go.dev</a> | <a href="https://github.com/SevenOfNine-ai/proton-git-lfs">GitHub</a></p>
            </footer>
          </body>
          </html>
          EOF

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-build/unified

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
